generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- ENUMS ---

enum ServiceType {
  STORAGE
  MOVING
  SHREDDING
}

enum OrderStatus {
  DRAFT
  QUOTED
  PENDING_PAYMENT
  PAID
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELED
  REFUNDED
}

enum PaymentStatus {
  REQUIRES_PAYMENT_METHOD
  REQUIRES_CONFIRMATION
  PROCESSING
  SUCCEEDED
  FAILED
  CANCELED
  REFUNDED
}

enum PaymentProvider {
  STRIPE
  CASH
  BANK_TRANSFER
  OTHER
}

enum AddressType {
  PICKUP
  DROPOFF
  BILLING
}

enum CatalogItemId {
  // STORAGE
  small_box
  medium_box
  large_box
  xl_box
  suitcase
  half_container
  full_container
  // MOVING
  small_move
  one_bedroom_flat
  two_bedroom_flat
  three_bedroom_flat
  four_bedroom_flat
  office_move
  // SHREDDING
  bag
  archive_box
}

enum MovingPackageId {
  basic_package
  move_and_pack
}

enum BillingUnit {
  PER_MONTH
  PER_ITEM
  FLAT
}

enum DiscountScope {
  GLOBAL
  PER_ITEM
}

enum Weekday {
  SUN
  MON
  TUE
  WED
  THU
  FRI
  SAT
}

enum TimeSlotKey {
  MORNING
  AFTERNOON
  EVENING
}

// --- MODELS ---

model Customer {
  id String @id @default(cuid())

  email                String?  @unique
  phone                String?
  fullName             String
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  stripeSubscriptionId String?
  subscriptionStatus   String?
  stripeCustomerId     String?  @unique

  orders              Order[]
  subscriptionInvoice SubscriptionInvoice[]
}

model AdminUser {
  id           String  @id @default(cuid())
  email        String  @unique
  name         String
  passwordHash String?
  role         String  @default("admin")
  isActive     Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ServiceItem {
  id          CatalogItemId @id
  serviceType ServiceType
  sku         String        @unique
  name        String
  description String?
  isActive    Boolean       @default(true)

  prices     ServiceItemPrice[]
  orderItems OrderItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([serviceType])
  @@index([isActive])
}

model ServiceItemPrice {
  id            String        @id @default(cuid())
  serviceItemId CatalogItemId
  serviceItem   ServiceItem   @relation(fields: [serviceItemId], references: [id], onDelete: Cascade)

  currency       String      @default("GBP")
  unitPriceMinor Int
  billingUnit    BillingUnit @default(PER_ITEM)

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([serviceItemId, currency])
}

model MovingPackage {
  id          MovingPackageId @id
  sku         String          @unique
  name        String
  description String?
  isActive    Boolean         @default(true)

  prices MovingPackagePrice[]
  orders Order[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model MovingPackagePrice {
  id            String          @id @default(cuid())
  packageId     MovingPackageId
  movingPackage MovingPackage   @relation(fields: [packageId], references: [id], onDelete: Cascade)

  currency   String @default("GBP")
  priceMinor Int

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([packageId, currency])
}

model Order {
  id          String      @id @default(cuid())
  orderNumber String      @unique @default(cuid())
  serviceType ServiceType
  status      OrderStatus @default(DRAFT)

  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Restrict)

  serviceDate DateTime?
  timeSlotId  String?
  timeSlot    TimeSlot? @relation(fields: [timeSlotId], references: [id])

  movingPackageId MovingPackageId
  movingPackage   MovingPackage?  @relation(fields: [movingPackageId], references: [id])
  distanceMiles   Int             @default(0)
  notes           String?

  currency      String @default("GBP")
  subtotalMinor Int    @default(0)
  discountMinor Int    @default(0)
  taxMinor      Int    @default(0)
  totalMinor    Int    @default(0)

  // Link to the Tier for auditing
  discountTierId      String?
  storageDiscountTier StorageDiscountTier? @relation(fields: [discountTierId], references: [id])

  stripeSubscriptionId String?   @unique
  subscriptionStatus   String?
  nextBillingAt        DateTime?
  cancelAt             DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items     OrderItem[]
  addresses Address[]
  payments  Payment[]

  @@index([customerId])
  @@index([status])
  @@index([serviceDate])
}

model OrderItem {
  id      String @id @default(cuid())
  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  serviceItemId CatalogItemId?
  serviceItem   ServiceItem?   @relation(fields: [serviceItemId], references: [id])

  sku      String?
  name     String
  quantity Int     @default(1)

  unitPriceMinor Int  @default(0)
  lineTotalMinor Int  @default(0)
  months         Int? // Used for storage duration

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orderId])
}

model Address {
  id         String      @id @default(cuid())
  orderId    String
  order      Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)
  type       AddressType
  line1      String
  line2      String
  city       String
  postalCode String
  country    String      @default("GB")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orderId])
}

model Payment {
  id          String          @id @default(cuid())
  orderId     String
  order       Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  provider    PaymentProvider @default(STRIPE)
  status      PaymentStatus   @default(PROCESSING)
  amountMinor Int
  providerRef String?         @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TimeSlot {
  id        String  @id @default(cuid())
  name      String  @unique
  startTime String?
  endTime   String?
  isActive  Boolean @default(true)

  orders Order[]
}

model StorageDiscountTier {
  id         String  @id @default(cuid())
  name       String?
  minMonths  Int     @unique
  percentOff Int
  isActive   Boolean @default(true)

  orders    Order[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AdminSettings {
  id String @id @default("global_settings") // Ensures only one row exists

  storageEnabled   Boolean @default(true)
  movingEnabled    Boolean @default(true)
  shreddingEnabled Boolean @default(true)

  movingPricePerMileMinor Int @default(58)
  packingAssistanceMinor  Int @default(29500)

  timeSlotSettings TimeSlotSetting[]
  capacities       CapacitySetting[]
  weekdayRules     WeekdayRule[]
  blackoutDates    BlackoutDate[]

  updatedAt DateTime @updatedAt
}

model TimeSlotSetting {
  id         String        @id @default(cuid())
  settingsId String
  settings   AdminSettings @relation(fields: [settingsId], references: [id], onDelete: Cascade)
  key        TimeSlotKey   @unique
  label      String
  enabled    Boolean       @default(true)
}

model CapacitySetting {
  id          String        @id @default(cuid())
  settingsId  String
  settings    AdminSettings @relation(fields: [settingsId], references: [id], onDelete: Cascade)
  serviceType ServiceType
  slotKey     TimeSlotKey
  capacity    Int           @default(5)

  @@unique([settingsId, serviceType, slotKey])
}

model WeekdayRule {
  id          String        @id @default(cuid())
  settingsId  String
  settings    AdminSettings @relation(fields: [settingsId], references: [id], onDelete: Cascade)
  serviceType ServiceType
  weekday     Weekday
  enabled     Boolean       @default(true)

  @@unique([settingsId, serviceType, weekday])
}

model BlackoutDate {
  id         String        @id @default(cuid())
  settingsId String
  settings   AdminSettings @relation(fields: [settingsId], references: [id], onDelete: Cascade)
  date       DateTime
  reason     String?

  @@unique([settingsId, date])
}

model SubscriptionInvoice {
  id String @id @default(cuid())

  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  stripeInvoiceId      String  @unique
  stripeSubscriptionId String?
  status               String
  currency             String
  amountDueMinor       Int     @default(0)
  amountPaidMinor      Int     @default(0)
  amountRemainingMinor Int     @default(0)

  hostedInvoiceUrl String?
  invoicePdf       String?
  number           String? // Stripe invoice number (e.g. "3C2F1F3-0001")
  billingReason    String?

  periodStart DateTime?
  periodEnd   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId])
  @@index([stripeSubscriptionId])
  @@index([createdAt])
}
