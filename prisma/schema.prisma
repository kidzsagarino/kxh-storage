// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ServiceType {
  STORAGE
  MOVING
  SHREDDING
}

enum OrderStatus {
  DRAFT
  QUOTED
  PENDING_PAYMENT
  PAID
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELED
  REFUNDED
}

enum PaymentStatus {
  REQUIRES_PAYMENT_METHOD
  REQUIRES_CONFIRMATION
  PROCESSING
  SUCCEEDED
  FAILED
  CANCELED
  REFUNDED
}

enum PaymentProvider {
  STRIPE
  CASH
  BANK_TRANSFER
  OTHER
}

enum AddressType {
  PICKUP
  DROPOFF
  BILLING
}

model Customer {
  id        String   @id @default(cuid())
  email     String?  @unique
  phone     String?
  fullName  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orders    Order[]
}

model AdminUser {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  // Store a hashed password if you do credentials auth.
  passwordHash String?
  role      String   @default("admin")
  isActive  Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Order {
  id            String      @id @default(cuid())
  orderNumber   String      @unique
  serviceType   ServiceType
  status        OrderStatus @default(DRAFT)

  customerId    String
  customer      Customer    @relation(fields: [customerId], references: [id], onDelete: Restrict)

  // Booking / schedule
  serviceDate   DateTime?
  timeSlotId    String?
  timeSlot      TimeSlot?   @relation(fields: [timeSlotId], references: [id], onDelete: SetNull)

  // Options / add-ons
  packingAssistance Boolean @default(false)
  notes         String?

  // Money fields (store in minor units e.g. pence)
  currency      String   @default("GBP")
  subtotalMinor Int      @default(0)
  discountMinor Int      @default(0)
  taxMinor      Int      @default(0)
  totalMinor    Int      @default(0)

  // Stripe (or other provider) helpful ids
  externalRef   String?  // e.g. Stripe Checkout Session id
  metadata      Json?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  items         OrderItem[]
  addresses     Address[]
  payments      Payment[]

  @@index([customerId])
  @@index([status])
  @@index([serviceType])
  @@index([serviceDate])
}

model OrderItem {
  id        String   @id @default(cuid())
  orderId   String
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  // Generic item lines for both STORAGE and MOVING
  sku       String?  // your internal id like "small-box" or "1-bedroom-flat"
  name      String
  quantity  Int      @default(1)

  // pricing in minor unit
  unitPriceMinor Int @default(0)
  lineTotalMinor Int @default(0)

  // For storage, you may want duration
  months    Int?

  // Extra details
  details   Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orderId])
}

model Address {
  id        String      @id @default(cuid())
  orderId   String
  order     Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)

  type      AddressType
  label     String?     // "Home", "Office", etc.
  line1     String
  line2     String?
  city      String
  region    String?     // county/state
  postalCode String
  country   String      @default("GB")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orderId])
}

model Payment {
  id          String          @id @default(cuid())
  orderId     String
  order       Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)

  provider    PaymentProvider @default(STRIPE)
  status      PaymentStatus   @default(REQUIRES_PAYMENT_METHOD)

  currency    String          @default("GBP")
  amountMinor Int

  // Provider refs (Stripe: payment_intent, charge, session)
  providerRef String?
  receiptUrl  String?
  raw         Json?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([orderId])
  @@index([status])
  @@index([provider])
}

model TimeSlot {
  id        String   @id @default(cuid())
  name      String   // e.g. "AM", "PM", "9:00-12:00"
  startTime String?  // "09:00" (optional)
  endTime   String?  // "12:00"
  isActive  Boolean  @default(true)

  orders    Order[]

  @@unique([name])
}

model Setting {
  key       String   @id
  value     Json
  updatedAt DateTime @updatedAt
}
